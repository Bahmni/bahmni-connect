# This workflow will do a clean install of node dependencies, build the source code and run tests across different versions of node
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: Node.js CI

on:
  push:
    branches: [ addCI ]
  pull_request:
    branches: [ ]

jobs:
  checkout:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [12.x]
    # defaults:
    #   run:
    #     working-directory:  /home/runner/work/bahmni-connect/
    steps:
    - uses: actions/checkout@v2
    - name: Setup Node
      uses: actions/setup-node@v1
    - name: Setup android
      uses: android-actions/setup-android@v2
    - run: npm install -g cordova ionic
    - run: npm install -g try-thread-sleep
    - run: npm install -g yarn
    - run: sudo gem install compass
    - run: echo $ANDROID_HOME
    - run: echo $GITHUB_WORKSPACE && pwd
    - run: cd .. && git clone https://github.com/Bahmni/bahmni-offline.git
    - run: cd .. && git clone https://github.com/Bahmni/bahmni-offline-sync.git 
    - run: ls
      working-directory: /home/runner/work/bahmni-connect/
    - run: cd ui && scripts/package.sh
    - name: Upload apps.zip as Artifact
      uses: actions/upload-artifact@v2
      with:
        name: apps.zip
        path: ui/bahmni-connect-apps.zip
      if: always()
    - name: run cordova android
    - run: cordova platform remove android && cordova platform add android && git checkout . 
      working-directory: /home/runner/work/bahmni-connect/bahmni-offline
    - run: cd android/www && rm -rf app/ && mkdir app
      working-directory: /home/runner/work/bahmni-connect/bahmni-offline
    - name: copy android dist
      run: cp -R bahmni-connect/ui/androidDist/* bahmni-offline/android/www/app/ && mkdir -p bahmni-offline/android/www/bahmni_config
      working-directory: /home/runner/work/bahmni-connect
    - name: Generate default_config.zip
      run: scripts/package.sh && cd .. && cp default-config/target/default_config.zip bahmni-offline/android/www/bahmni_config/default_config.zip
      working-directory: /home/runner/work/bahmni-connect/default_config
    - name: Upload apps.zip as Artifact
      uses: actions/upload-artifact@v2
      with:
        name: default-config zip
        path: target/default_config.zip
        working-directory: /home/runner/work/bahmni-connect/default-config
      if: always()
    - name: copy config zip to android folder
      run: cd bahmni-offline/android/www/bahmni_config/ && unzip -o default_config.zip && rm -rf apps aqs beanshell encounterModifier migrations obscalculator ordertemplates templates patientMatchingAlgorithm treatmentRegimenExtension openelis default_config.zip
      working-directory: /home/runner/work/bahmni-connect
    - name: Build Android APK
      # run: cd bahmni-android/android && cp /bahmni-apk-signing/release-signing.properties platforms/android/
      run: cordova build android #Debug apk
      working-directory: /home/runner/work/bahmni-connect/bahmni-offline/android
    